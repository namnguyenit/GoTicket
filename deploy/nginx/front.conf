upstream user_fe_pool {
  server user-fe-1:80 max_fails=3 fail_timeout=10s;
  server user-fe-2:80 max_fails=3 fail_timeout=10s;
  server user-fe-3:80 max_fails=3 fail_timeout=10s;
  keepalive 64;
}

upstream admin_fe_pool {
  server admin-fe:80 max_fails=3 fail_timeout=10s;
  keepalive 16;
}

upstream vendor_fe_pool {
  server vendor-fe:3000 max_fails=3 fail_timeout=10s;
  keepalive 16;
}

server {
  listen 80;
  server_name _;

  # User FE at /
  location / {
    proxy_pass http://user_fe_pool;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  # Admin FE at /admin/
  location /admin/ {
    proxy_pass http://admin_fe_pool/;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  # Vendor FE at /vendor/
  location /vendor/ {
    proxy_pass http://vendor_fe_pool/;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  # API proxy to back LB at /api
  location /api/ {
    proxy_pass http://nginx-back-1/;
    proxy_http_version 1.1;
    proxy_set_header Connection "";
    proxy_set_header Host $host;
    proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
  }

  location = /nginx_health { return 200 'ok'; add_header Content-Type text/plain; }
}
